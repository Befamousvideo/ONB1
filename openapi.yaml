openapi: 3.1.0
info:
  title: ONB1 API
  version: 1.0.0
  summary: OpenAPI contract for conversation intake, file uploads, and handoff workflows.

servers:
  - url: https://api.onb1.local
    description: Example production endpoint
  - url: http://localhost:3000
    description: Local development endpoint

tags:
  - name: Conversations
    description: End-user conversation lifecycle APIs.
  - name: Uploads
    description: File upload pre-signing APIs.
  - name: Internal
    description: Internal-only platform integrations.

paths:
  /api/conversations:
    post:
      tags: [Conversations]
      operationId: createConversation
      summary: Create a new intake conversation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
      responses:
        '201':
          description: Conversation created.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/conversations/{id}/message:
    post:
      tags: [Conversations]
      operationId: createConversationMessage
      summary: Add a message to an existing conversation.
      parameters:
        - $ref: '#/components/parameters/ConversationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMessageRequest'
      responses:
        '201':
          description: Message persisted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/conversations/{id}/end-and-send:
    post:
      tags: [Conversations]
      operationId: endConversationAndSend
      summary: Finalize the conversation and dispatch intake handoff.
      parameters:
        - $ref: '#/components/parameters/ConversationId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EndConversationRequest'
      responses:
        '200':
          description: Conversation ended and handoff queued/sent.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EndConversationResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conversation already ended.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/uploads/presign:
    post:
      tags: [Uploads]
      operationId: createUploadPresign
      summary: Create a pre-signed upload URL for client-side asset upload.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadPresignRequest'
      responses:
        '201':
          description: Upload URL generated.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadLink'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/handoff/slack:
    post:
      tags: [Internal]
      operationId: sendSlackHandoff
      summary: Internal endpoint to post an intake brief to Slack.
      x-internal: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SlackHandoffRequest'
      responses:
        '202':
          description: Slack handoff accepted for delivery.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlackHandoffResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  parameters:
    ConversationId:
      name: id
      in: path
      required: true
      description: Unique conversation identifier.
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Request payload failed validation.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Requested resource was not found.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalError:
      description: Internal server error.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    Conversation:
      type: object
      additionalProperties: false
      required:
        - id
        - status
        - createdAt
        - updatedAt
        - messages
      properties:
        id:
          type: string
          format: uuid
        status:
          type: string
          enum: [active, ended]
        participantName:
          type: string
          minLength: 1
        participantEmail:
          type: string
          format: email
        intakeBrief:
          $ref: '#/components/schemas/IntakeBrief'
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Message:
      type: object
      additionalProperties: false
      required:
        - id
        - conversationId
        - role
        - content
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        role:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
          minLength: 1
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/Attachment'
          default: []
        createdAt:
          type: string
          format: date-time

    IntakeBrief:
      type: object
      additionalProperties: false
      required:
        - summary
        - goals
        - constraints
      properties:
        summary:
          type: string
          minLength: 1
        goals:
          type: array
          minItems: 1
          items:
            type: string
            minLength: 1
        constraints:
          type: array
          items:
            type: string
            minLength: 1
        timeline:
          type: string
        budget:
          type: string
        recommendedNextSteps:
          type: array
          items:
            type: string
            minLength: 1

    UploadLink:
      type: object
      additionalProperties: false
      required:
        - uploadUrl
        - fileUrl
        - method
        - expiresAt
        - headers
      properties:
        uploadUrl:
          type: string
          format: uri
        fileUrl:
          type: string
          format: uri
        method:
          type: string
          enum: [PUT, POST]
        expiresAt:
          type: string
          format: date-time
        headers:
          type: object
          description: Headers the client must include in the upload request.
          additionalProperties:
            type: string

    Attachment:
      type: object
      additionalProperties: false
      required: [fileUrl]
      properties:
        fileUrl:
          type: string
          format: uri
        fileName:
          type: string
        contentType:
          type: string
        sizeBytes:
          type: integer
          minimum: 0

    CreateConversationRequest:
      type: object
      additionalProperties: false
      required: [participantName, participantEmail]
      properties:
        participantName:
          type: string
          minLength: 1
        participantEmail:
          type: string
          format: email
        initialMessage:
          type: string
          minLength: 1

    CreateMessageRequest:
      type: object
      additionalProperties: false
      required: [content]
      properties:
        content:
          type: string
          minLength: 1
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/Attachment'

    EndConversationRequest:
      type: object
      additionalProperties: false
      properties:
        notes:
          type: string
          description: Optional operator note to include with handoff.

    EndConversationResponse:
      type: object
      additionalProperties: false
      required: [conversation, handoffQueued]
      properties:
        conversation:
          $ref: '#/components/schemas/Conversation'
        handoffQueued:
          type: boolean

    UploadPresignRequest:
      type: object
      additionalProperties: false
      required: [fileName, contentType]
      properties:
        fileName:
          type: string
          minLength: 1
        contentType:
          type: string
          minLength: 1
        contentLength:
          type: integer
          minimum: 1

    SlackHandoffRequest:
      type: object
      additionalProperties: false
      required: [conversationId, brief]
      properties:
        conversationId:
          type: string
          format: uuid
        brief:
          $ref: '#/components/schemas/IntakeBrief'
        destinationChannel:
          type: string
          description: Optional override channel for routing.

    SlackHandoffResponse:
      type: object
      additionalProperties: false
      required: [accepted]
      properties:
        accepted:
          type: boolean
        messageTs:
          type: string
          description: Slack message timestamp if sent synchronously.

    ErrorResponse:
      type: object
      additionalProperties: false
      required: [error]
      properties:
        error:
          type: string
        details:
          type: array
          items:
            type: string
