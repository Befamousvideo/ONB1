openapi: 3.0.3
info:
  title: ONB1 API
  version: 0.1.0
  description: API contract v1.
servers:
  - url: http://localhost:8000
paths:
  /api/conversations:
    post:
      summary: Create a conversation
      operationId: createConversation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConversationCreate'
      responses:
        '201':
          description: Conversation created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
  /api/conversations/{id}:
    get:
      summary: Get a conversation
      operationId: getConversation
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
  /api/conversations/{id}/message:
    post:
      summary: Add a message to a conversation
      operationId: postMessage
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageCreate'
      responses:
        '201':
          description: Message created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
  /api/conversations/{id}/end-and-send:
    post:
      summary: End a conversation and send final output
      operationId: endAndSendConversation
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EndAndSendRequest'
      responses:
        '200':
          description: Conversation ended and sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Conversation'
  /api/uploads/presign:
    post:
      summary: Generate a presigned upload link
      operationId: createUploadPresign
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadPresignRequest'
      responses:
        '200':
          description: Upload link generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadLink'
  /api/auth/request-otp:
    post:
      summary: Request a one-time code for existing client login
      operationId: requestOtp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        '200':
          description: OTP challenge created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthChallenge'
  /api/auth/verify-otp:
    post:
      summary: Verify a one-time code and create a session
      operationId: verifyOtp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthVerifyRequest'
      responses:
        '200':
          description: Session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSession'
  /api/projects:
    get:
      summary: List projects for the authenticated account
      operationId: listProjects
      parameters: []
      responses:
        '200':
          description: Projects
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Project'
  /api/requests:
    post:
      summary: Create a client request
      operationId: createRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientRequestCreate'
      responses:
        '200':
          description: Request created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientRequestResponse'
  /api/requests/{id}/updates:
    post:
      summary: Post an update to a client request
      operationId: updateRequest
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestUpdate'
      responses:
        '200':
          description: Update posted
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
  /api/handoff/slack:
    post:
      summary: Internal Slack handoff
      operationId: handoffSlack
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SlackHandoffRequest'
      responses:
        '200':
          description: Handoff dispatched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SlackHandoffResponse'
components:
  schemas:
    Conversation:
      type: object
      required: [id, account_id, channel, created_at, mode, state, normalized_fields]
      properties:
        id:
          type: string
          format: uuid
        account_id:
          type: string
          format: uuid
        contact_id:
          type: string
          format: uuid
          nullable: true
        channel:
          type: string
        subject:
          type: string
          nullable: true
        intake_brief:
          $ref: '#/components/schemas/IntakeBrief'
          nullable: true
        mode:
          type: string
        state:
          type: string
        normalized_fields:
          type: object
          additionalProperties: true
        summary:
          type: string
          nullable: true
        ended_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
    Message:
      type: object
      required: [id, conversation_id, sender_type, body, created_at]
      properties:
        id:
          type: string
          format: uuid
        conversation_id:
          type: string
          format: uuid
        sender_type:
          type: string
          description: contact|system|agent
        sender_contact_id:
          type: string
          format: uuid
          nullable: true
        body:
          type: string
        created_at:
          type: string
          format: date-time
    IntakeBrief:
      type: object
      required: [summary]
      properties:
        summary:
          type: string
        goals:
          type: string
          nullable: true
        constraints:
          type: string
          nullable: true
    UploadLink:
      type: object
      required: [upload_url, file_url, key, max_size]
      properties:
        upload_url:
          type: string
        file_url:
          type: string
        key:
          type: string
        max_size:
          type: integer
        headers:
          type: object
          additionalProperties:
            type: string
    ConversationCreate:
      type: object
      required: [account_id, channel]
      properties:
        account_id:
          type: string
          format: uuid
        contact_id:
          type: string
          format: uuid
          nullable: true
        channel:
          type: string
        subject:
          type: string
          nullable: true
        intake_brief:
          $ref: '#/components/schemas/IntakeBrief'
    MessageCreate:
      type: object
      required: [sender_type, body]
      properties:
        sender_type:
          type: string
        sender_contact_id:
          type: string
          format: uuid
          nullable: true
        body:
          type: string
        fields:
          type: object
          description: Normalized field values for the current state.
          additionalProperties: true
    EndAndSendRequest:
      type: object
      properties:
        summary:
          type: string
          nullable: true
    UploadPresignRequest:
      type: object
      required: [file_name, content_type, content_length]
      properties:
        file_name:
          type: string
        content_type:
          type: string
        content_length:
          type: integer
          format: int64
        conversation_id:
          type: string
          format: uuid
          nullable: true
    Attachment:
      type: object
      required: [file_name, content_type, size, url, key]
      properties:
        file_name:
          type: string
        content_type:
          type: string
        size:
          type: integer
          format: int64
        url:
          type: string
        key:
          type: string
    AuthRequest:
      type: object
      required: [email]
      properties:
        email:
          type: string
    AuthVerifyRequest:
      type: object
      required: [challenge_id, code]
      properties:
        challenge_id:
          type: string
          format: uuid
        code:
          type: string
    AuthChallenge:
      type: object
      required: [challenge_id, expires_at]
      properties:
        challenge_id:
          type: string
          format: uuid
        expires_at:
          type: string
          format: date-time
        dev_code:
          type: string
          nullable: true
    AuthSession:
      type: object
      required: [token, account_id]
      properties:
        token:
          type: string
        account_id:
          type: string
          format: uuid
    Project:
      type: object
      required: [id, name, status]
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        status:
          type: string
        start_date:
          type: string
          format: date
          nullable: true
        end_date:
          type: string
          format: date
          nullable: true
    ClientRequestCreate:
      type: object
      required: [project_id, request_type, description, impact, urgency]
      properties:
        project_id:
          type: string
          format: uuid
        request_type:
          type: string
        description:
          type: string
        impact:
          type: string
        urgency:
          type: string
        attachments:
          type: array
          items:
            $ref: '#/components/schemas/Attachment'
    ClientRequestResponse:
      type: object
      required: [id, slack_ts]
      properties:
        id:
          type: string
          format: uuid
        slack_ts:
          type: string
    RequestUpdate:
      type: object
      required: [message]
      properties:
        message:
          type: string
    SlackHandoffRequest:
      type: object
      required: [conversation_id, channel, text]
      properties:
        conversation_id:
          type: string
          format: uuid
        channel:
          type: string
        text:
          type: string
    SlackHandoffResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
